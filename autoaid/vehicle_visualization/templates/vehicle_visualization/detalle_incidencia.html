<!-- vehicle_visualization/templates/vehicle_visualization/detalle_incidencia.html -->
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
      <!-- Google Fonts -->
     <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
      <!-- Remixicon Icon -->
      <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">
      <!-- Remixicon Icon -->
      <!-- Bootstrap CSS -->
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
      <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
      <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/>

      <!-- Main CSS -->
      {% load static %}
      <link rel="stylesheet" href="{% static 'css/main.css' %}">
      


    <title>Dashboard</title>
  </head>
  <body>
    
  <header class="ds-header ds-header-home">
    <div class="container">
        <div class="ds-header-inner">
          <a href="index.html" class="ds-logo">autoAID<span>.</span></a>
          <p>¡Bienvenido, {{ user.nombre }} !  <a href="{% url 'logout' %}" style="color: red; font-size: small;">Cerrar sesión</a></p>
        </div>
    </div>
    <!-- Botones basados en el rol de usuario -->
  <div class="container mt-4">
    
      {% if user.rol == 'worker' %}
          <!-- Botón para workers -->
      <a href="{% url 'vehicle_visualization:dashboard_incidencias' %}" class="btn btn-primary">Dashboard</a>
      {% endif %}

      {% if user.rol == 'usuario' %}
          <!-- Botón para usuarios -->
      <a href="{% url 'vehicle_visualization:car' %}" class="btn btn-primary">Incidencia</a>
      {% endif %}

      {% if user.is_superuser %}
          <!-- Botón para superusuarios -->
      <a href="{% url 'manage_users' %}" class="btn btn-danger">Manage Users</a>
          <!-- Superuser también puede ver el dashboard -->
      <a href="{% url 'vehicle_visualization:dashboard_incidencias' %}" class="btn btn-primary">Dashboard</a>
      <a href="{% url 'home' %}" class="btn btn-success">Home</a>
      {% endif %}
</div>

</header>
{% block content %}
<div class="container mt-4">
    <h2>Detalle de Incidencia</h2>
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">{{ incidencia.marca_modelo }}</h5>
            <h6 class="card-subtitle mb-2 text-muted">Matrícula: {{ incidencia.matricula }}</h6>
            <p class="card-text">{{ incidencia.descripcion }}</p>
            <!-- Agrega más campos de detalles como sea necesario -->
            <!-- Imagenes -->
            {% if incidencia.imagen_capo %}
            <div>
                <h5>Imagen del Capó</h5>
                <img src="{{ incidencia.imagen_capo.url }}" alt="Imagen del Capó" class="img-fluid">
            </div>
            {% endif %}
            <!-- Repetir para otras imágenes y campos -->
        </div>
    </div>
    <!-- Aquí puedes incluir un botón de regreso o acciones adicionales -->
    <button id="enviarDrools" class="btn btn-primary">Enviar Datos</button>
    <a href="{% url 'vehicle_visualization:ver_analisis_drools' incidencia.id %}" class="btn btn-primary">Ver Análisis</a>

</div>
{% block javascript %}
<script>
function enviarDatosDrools() {
    // Crear el objeto de datos con la ubicación
    var datosIncidencia = {
        "ubicacion": "{{ incidencia.ubicacion_siniestro }}",
        // "fechaYHora": "{{ incidencia.fecha_hora_siniestro}}",
        "tipoAparcamiento": "{{ incidencia.tipo_aparcamiento}}",
        "llamadaPolicia": "{{ incidencia.llamada_policia}}",
        "matricula": "{{ incidencia.matricula}}",
        "numeroIncidenciaPolicial": "{{ incidencia.numero_incidencia_policial}}",
        "testigo": "{{ incidencia.testigo}}",
        "contactoTestigo": "{{ incidencia.contacto_testigo}}",
        "vehiculosPropiedadesInvolucrados": "{{ incidencia.vehiculos_propiedades_involucrados}}"
    };

    // Realizar la petición POST a Drools
    fetch('http://localhost:8080/procesar-siniestro', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(datosIncidencia)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok: ' + response.statusText);
        }
        return response.json();  // Suponemos que Drools responde con JSON
    })
    .then(data => {
        console.log('Respuesta de Drools:', data);

        // Suponiendo que la respuesta de Drools contiene las claves 'respuestas' y 'recomendaciones'
        var respuestasRecomendaciones = {
            "incidencia_id": "{{ incidencia.id }}",
            "respuestas": data.respuestas,
            "recomendaciones": data.recomendaciones
        };

        // Enviar la respuesta de Drools a Django
        return fetch('/procesar-respuesta-drools/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),  // Asegúrate de obtener el token CSRF correctamente
            },
            body: JSON.stringify(respuestasRecomendaciones)
        });
    })
    .then(responseDjango => {
        if (!responseDjango.ok) {
            throw new Error('Network response was not ok: ' + responseDjango.statusText);
        }
        return responseDjango.json();  // Procesar la respuesta de Django
    })
    .then(dataDjango => {
        console.log('Respuesta de Django:', dataDjango);
        // Aquí manejarías la respuesta de Django, como mostrar un mensaje al usuario
    })
    .catch(error => {
        console.error('Error:', error);
        // Aquí manejarías el error. Por ejemplo, mostrando una alerta al usuario.
    });
}

// Función para obtener el valor de una cookie por su nombre
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.getElementById("enviarDrools").addEventListener('click', enviarDatosDrools);
</script>
{% endblock %}


{% endblock %}


</body>